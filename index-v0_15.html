<html>
<head>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript">

function getScrollBarWidth () {
	var inner = document.createElement('p');
	inner.style.width = "100%";
	inner.style.height = "200px";

	var outer = document.createElement('div');
	outer.style.position = "absolute";
	outer.style.top = "0px";
	outer.style.left = "0px";
	outer.style.visibility = "hidden";
	outer.style.width = "200px";
	outer.style.height = "150px";
	outer.style.overflow = "hidden";
	outer.appendChild (inner);

	document.body.appendChild (outer);
	var w1 = inner.offsetWidth;
	outer.style.overflow = 'scroll';
	var w2 = inner.offsetWidth;
	if (w1 == w2) w2 = outer.clientWidth;

	document.body.removeChild (outer);

	return (w1 - w2);
};

var PhotoWall = {
	//Max image width form Picasa
	// 94, 110, 128, 200, 220, 288, 320, 400, 512, 576, 640, 720, 800, 912, 1024, 1152, 1280, 1440, 1600 
	imgMax:720,
	photos: [],
	el: null,
	nextLineFactor: 0.95,
	removeImageFactor: 1.15,
	cWidth: 0,
	cHeight: 0,
	lineMaxHeight: 150,
	_padding: 10,
	_zoom: 2,
	_zoom_trigger: null,
	_zs: null,
	_zt: null,
	
	
	init: function(el,user,album) {	
		PhotoWall.el = el;
		PhotoWall.cWidth = $(el+' .body').width()-getScrollBarWidth();
		PhotoWall.cHeight = $(el+' .body').height();	
		$(el+' .body').html('');
		
		$(window).resize(function(){		
			$(PhotoWall.el+' .body').html('');
			PhotoWall.cWidth = $(PhotoWall.el+' .body').width()-getScrollBarWidth();
			PhotoWall.cHeight = $(PhotoWall.el+' .body').height();	
			PhotoWall.show();
		});
		$.ajax({
			url: 'https://picasaweb.google.com/data/feed/api/user/'+user+'/albumid/'+album
				 +'/?alt=json&fields=entry(gphoto:id,title,media:group(media:thumbnail,media:'
				 +'content))&imgmax='+PhotoWall.imgMax,
			dataType: 'jsonp',
			success: function(data){
			    var photos = [];
		        if(!data.feed.entry) return;
		        for(var i in data.feed.entry) {
			        var e = data.feed.entry[i].media$group;
			        var h = e.media$thumbnail[2].height;
			        var w = e.media$thumbnail[2].width;
			        photos.push({id:data.feed.entry[i].gphoto$id.$t,bigImg:e.media$content[0].url,thumbnail:{src:e.media$thumbnail[2].url,width:w,height:h}});
		        }	
			    PhotoWall.load(photos);
		    }
		});
	},
	load: function(data) {		
	    PhotoWall.photos = data;
	    for(var i in PhotoWall.photos) {
	        var el = PhotoWall.photos[i];
			PhotoWall.photos[i].thumbnail.width  = Math.floor(PhotoWall.lineMaxHeight/el.thumbnail.height * el.thumbnail.width);
			PhotoWall.photos[i].thumbnail.height = PhotoWall.lineMaxHeight;
	    }
		PhotoWall.show();
	},
	show: function() {
		if(!PhotoWall.photos) return;
		var line = [];
		var totalWidth = 0;	
		var type = 'display:inline-block;';
		if($.browser.msie) 
			type = 'float:left;';
		var showLine = function(line,tW,last) {
			var ln = $("<div class='line'></div>").appendTo(PhotoWall.el+' .body'); 
			var hCoef = PhotoWall.cWidth / tW;
			if(last)
				var hCoef = 1;
			var l = 0;
			var max = line.length;			
			
			for(var k in line) {	
				var w = Math.round(line[k].thumbnail.width*hCoef);
				var h = Math.round(line[k].thumbnail.height*hCoef);
				l += w+PhotoWall._padding;
				if(max-1 == k && !last) {
					w += PhotoWall.cWidth - l;
					l += PhotoWall.cWidth - l;
				}
				var t = $('<div class="photo" style="position:relative;top:0px;left:0px;width:'+w+'px;height:'+h+'px;'+type+'"><a id="'+line[k].id+'" class="pw-link" href="'+line[k].bigImg+'">'
					+'<img class="effectzoom" style="position:absolute;top:0px;left:0px;" src="'+line[k].thumbnail.src+'" width="'
					+w+'" height="'+h+'" /></a><div>');
				if($.browser.msie) {
					t.fadeIn(3000);
				} else {
					t.css('opacity',0).delay(Math.random()*(1000 - 300)+300).animate({"opacity":1},{duration:1000});
				}
				ln.append(t);
			}
		};
		
		for(var i in PhotoWall.photos) {	
			var e = PhotoWall.photos[i];
			line.push(e);
			totalWidth += e.thumbnail.width+PhotoWall._padding;
			
			if(totalWidth >= PhotoWall.cWidth*PhotoWall.nextLineFactor && totalWidth <= PhotoWall.cWidth*PhotoWall.removeImageFactor) {
				showLine(line,totalWidth);
				line = [];
				totalWidth = 0;
			} else if(totalWidth >= PhotoWall.cWidth*PhotoWall.nextLineFactor && totalWidth > PhotoWall.cWidth*PhotoWall.removeImageFactor) {
				line.pop();
				showLine(line,totalWidth-e.thumbnail.width-PhotoWall._padding);
				line = [e];
				totalWidth = e.thumbnail.width+PhotoWall._padding;
			}	
		}
		if(line)
			showLine(line,totalWidth,1);
		var ts = (new Date()).getTime() / 1000;
		PhotoWall.initGUI();
		//alert('done in: '+((new Date()).getTime() / 1000-ts)+' sec.');

	},
	initGUI: function() {
		PhotoWall.initZoom();
		PhotoWall.initShowBox();
	},
	initShowBox: function() {
		$('.pw-link').live('click',function(e){
			e.preventDefault();
		});
	},
	initZoom: function() {
		PhotoWall._w = [];
		PhotoWall._h = [];
		$(".effectzoom").mouseout(function () {
			clearTimeout(PhotoWall._zt);
		});
		$(".effectzoom").mouseover(function () {
			var tht = this;
			clearTimeout(PhotoWall._zt);
			PhotoWall._zoom_trigger = this;
			PhotoWall._zt = setTimeout(function(){
				var th = tht;
				if(PhotoWall._zoom_trigger != th) return;
				
				if(PhotoWall._zs) {;
					var th$ = PhotoWall._zs[0];
					var thn$ = PhotoWall._zs[1];
					PhotoWall._zs = null;
					thn$.find('img').animate({
						"width": $(th$).width(),
						"height": $(th$).height(),
						"padding":0
					}, {
						queue: false,
						duration: 100
					});
					thn$.animate({
						"left": $(th$).offset().left-PhotoWall._padding*0.5,
						"top": $(th$).offset().top-PhotoWall._padding*0.5
					}, {
						queue: false,
						duration: 100,
						complete: function(){var t = thn$;t.remove();}
					});
				}
				
				var bigIMG = $('<img/>');
				bigIMG.attr('src',th.src+'/../../w'+Math.round($(th).width() * PhotoWall._zoom)+'-h'
									+Math.round($(th).height() * PhotoWall._zoom)+'/');
				thn = $(th).parent().parent().clone();
				bigIMG.load(function(){ 
				    var im = th;
				    var im2 = thn.find('img');
				    im.src = im.src+'/../../w'+Math.round($(th).width() * PhotoWall._zoom)+'-h'
									+Math.round($(th).height() * PhotoWall._zoom)+'/';
					im2.attr('src',im.src);
					$(this).remove();
				});
				
				
				PhotoWall._zs = [th,thn];
				thn.appendTo(PhotoWall.el+' .body');
				thn.css({
					"position":"absolute",
					"left":$(th).offset().left-PhotoWall._padding*0.5+"px",
					"top":$(th).offset().top-PhotoWall._padding*0.5+"px"	
				});
					
				var w  = $(th).width() * PhotoWall._zoom;
				var h  = $(th).height() * PhotoWall._zoom;
				var dw = $(th).width() * PhotoWall._zoom - $(th).width();
				var dh = $(th).height() * PhotoWall._zoom - $(th).height();
				var l  = -(dw) * 0.5-PhotoWall._padding*0.5;
				var t  = -(dh) * 0.5-PhotoWall._padding*0.5;
				var o  = $(th).offset(); 
				var wn = $(window);
				
				if(o.left + l + w > (wn.width()+wn.scrollLeft()))
					l -= (o.left + l + w) - (wn.width()+wn.scrollLeft())+PhotoWall._padding*2; 
				
				if(o.left + l < +wn.scrollLeft())
					l -= (o.left + l)-wn.scrollLeft();
				
				if(o.top + t + h > (wn.height()+wn.scrollTop()))
					t -= (o.top + t + h) - (wn.height()+wn.scrollTop())+PhotoWall._padding*2; 
				
				if(o.top + t < wn.scrollTop())
					t -= (o.top + t)-wn.scrollTop();
	
				l = o.left + l;
				t = o.top + t;
				thn.find('img').removeClass('effectzoom');
				thn.css({'box-shadow':'0 0 '+(PhotoWall._padding*0.5)+'px rgba(0,0,0,0.7)'});			
				thn.css({'-webkit-box-shadow':'0 0 '+(PhotoWall._padding*0.5)+'px rgba(0,0,0,0.7)'});
				thn.css({'-moz-box-shadow':'0 0 '+(PhotoWall._padding*0.5)+'px rgba(0,0,0,0.7)'});
				thn.animate({
					"left": l,
					"top": t,
					"width": w+PhotoWall._padding,
					"height": h+PhotoWall._padding
				}, {
					queue: false,
					duration: 100
				});
				thn.find('img').animate({
					"width": w,
					"height": h,
					"padding": PhotoWall._padding*0.5
				}, {
					queue: false,
					duration: 100
				});
				thn.css("z-index", 1000);
				thn.mouseout(function(){
					if(!PhotoWall._zs) return;
					var th = PhotoWall._zs[0];
					var thn = PhotoWall._zs[1];
					PhotoWall._zs = null;
					thn.css({'box-shadow':'none'});			
					thn.css({'-webkit-box-shadow':'none'});
					thn.css({'-moz-box-shadow':'none'});
					thn.find('img').animate({
						"width": $(th).width(),
						"height": $(th).height(),
						"padding":0
					}, {
						queue: false,
						duration: 100
					});
					thn.animate({
						"left": $(th).offset().left-PhotoWall._padding*0.5,
						"top": $(th).offset().top-PhotoWall._padding*0.5
					}, {
						queue: false,
						duration: 100,
						complete: function(){var t = thn;t.remove();PhotoWall._zs = null;}
					});
				});
			},500);
		});
	},
	showGallery: function(id) {
	
	}
}

$(document).ready(function(){
PhotoWall.init('#gallery','118283508237214694671','5284120184954723249');
});

</script>

<style type="text/css">
html,body {
	padding:0;
	margin: 0;
	background:#fff;
}
* {outline:none;}
div.photo {
	margin:5px;
}
div.photo a {
	text-decoration: none;
	outline: none;
	border: none;
}
div.photo img {
	background:white;
	border:none;
	outline: none;
	zoom: 1;
}
#gallery .body{
}
</style>
</head>
<body>


<div id="gallery">
	<div class="body">
	</div>
</div>
</body>
</html>
